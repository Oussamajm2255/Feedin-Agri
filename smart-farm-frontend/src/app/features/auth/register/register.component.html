<div class="login-container" [class.video-loaded]="isVideoLoaded()" [class.video-error]="videoError()">

  <!-- Background video (always muted) -->
  <video #bgVideo class="video-background" preload="auto" playsinline muted autoplay loop (canplay)="onVideoLoaded()"
    (error)="onVideoError()" *ngIf="!videoError()">
    <source [src]="config.assets.loginVideo" type="video/mp4">
  </video>

  <!-- Glassmorphism overlay -->
  <div class="glass-overlay"></div>

  <!-- Back to Landing Button -->
  <button class="back-to-landing" routerLink="/"
    [attr.aria-label]="languageService.t()('auth.backToHome') || 'Back to Home'">
    <mat-icon>home</mat-icon>
    <span>{{ languageService.t()('auth.backToHome') || 'Home' }}</span>
  </button>

  <!-- Register card -->
  <mat-card class="login-card register-card-override" [@fadeInDown]
    [attr.data-state]="isCardActive() ? 'active' : 'passive'">

    <!-- Logo section -->
    <div class="logo-section">
      <mat-icon *ngIf="showFallbackIcon(); else logoImage" class="fallback-icon">
        agriculture
      </mat-icon>
      <ng-template #logoImage>
        <img [src]="config.assets.logo" alt="Feedin Logo" (error)="onLogoError($event)" />
      </ng-template>
      <h2>{{ languageService.t()('auth.requestAccess') || 'Request Access' }}</h2>
      <p>{{ languageService.t()('auth.registerSubtitle') || "Tell us about your farm" }}</p>
    </div>

    <!-- Step indicator -->
    <div class="step-indicator">
      <div class="step" [class.active]="currentStep() === 1" [class.completed]="currentStep() === 2"
        (click)="goToStep(1)">
        <div class="step-circle">
          <mat-icon *ngIf="currentStep() === 2">check</mat-icon>
          <span *ngIf="currentStep() !== 2">1</span>
        </div>
        <span class="step-label">{{ languageService.t()('auth.stepAccount') || 'Account' }}</span>
      </div>
      <div class="step-line" [class.active]="currentStep() === 2"></div>
      <div class="step" [class.active]="currentStep() === 2">
        <div class="step-circle">2</div>
        <span class="step-label">{{ languageService.t()('auth.stepFarm') || 'Farm' }}</span>
      </div>
    </div>

    <!-- Register form -->
    <form [formGroup]="registerForm" (ngSubmit)="onSubmit()" class="login-form">

      <!-- ============ STEP 1: Account Info ============ -->
      <div class="step-content" *ngIf="currentStep() === 1">

        <!-- Full Name -->
        <mat-form-field appearance="outline" class="full-width" (focusin)="onFocus($event)" (focusout)="onBlur($event)">
          <mat-label>{{ languageService.t()('auth.fullName') || 'Full Name' }}</mat-label>
          <input matInput formControlName="full_name" placeholder="e.g. Ahmed Ben Ali">
          <mat-icon matPrefix>person</mat-icon>
          <mat-error *ngIf="registerForm.get('full_name')?.invalid && registerForm.get('full_name')?.touched">
            {{ getErrorMessage('full_name') }}
          </mat-error>
        </mat-form-field>

        <!-- Email -->
        <mat-form-field appearance="outline" class="full-width" (focusin)="onFocus($event)" (focusout)="onBlur($event)">
          <mat-label>{{ languageService.t()('auth.email') || 'Email' }}</mat-label>
          <input matInput type="email" formControlName="email" placeholder="name@example.com">
          <mat-icon matPrefix>alternate_email</mat-icon>
          <mat-error *ngIf="registerForm.get('email')?.invalid && registerForm.get('email')?.touched">
            {{ getErrorMessage('email') }}
          </mat-error>
        </mat-form-field>

        <!-- Phone (optional) -->
        <mat-form-field appearance="outline" class="full-width" (focusin)="onFocus($event)" (focusout)="onBlur($event)">
          <mat-label>{{ languageService.t()('auth.phoneOptional') || 'Phone (Optional)' }}</mat-label>
          <input matInput type="tel" formControlName="phone" placeholder="+216 XX XXX XXX">
          <mat-icon matPrefix>phone</mat-icon>
        </mat-form-field>

        <!-- Password -->
        <mat-form-field appearance="outline" class="full-width" (focusin)="onFocus($event)" (focusout)="onBlur($event)">
          <mat-label>{{ languageService.t()('auth.password') || 'Password' }}</mat-label>
          <input matInput [type]="hidePassword ? 'password' : 'text'" formControlName="password"
            placeholder="Min. 6 characters">
          <mat-icon matPrefix>lock_outline</mat-icon>
          <button mat-icon-button matSuffix type="button" (click)="hidePassword = !hidePassword" tabindex="-1">
            <mat-icon>{{hidePassword ? 'visibility_off' : 'visibility'}}</mat-icon>
          </button>
          <mat-error *ngIf="registerForm.get('password')?.invalid && registerForm.get('password')?.touched">
            {{ getErrorMessage('password') }}
          </mat-error>
        </mat-form-field>

        <!-- Confirm Password -->
        <mat-form-field appearance="outline" class="full-width" (focusin)="onFocus($event)" (focusout)="onBlur($event)">
          <mat-label>{{ languageService.t()('auth.confirmPassword') || 'Confirm Password' }}</mat-label>
          <input matInput [type]="hideConfirmPassword ? 'password' : 'text'" formControlName="confirmPassword"
            placeholder="Re-enter password">
          <mat-icon matPrefix>lock_outline</mat-icon>
          <button mat-icon-button matSuffix type="button" (click)="hideConfirmPassword = !hideConfirmPassword"
            tabindex="-1">
            <mat-icon>{{hideConfirmPassword ? 'visibility_off' : 'visibility'}}</mat-icon>
          </button>
          <mat-error
            *ngIf="registerForm.get('confirmPassword')?.invalid && registerForm.get('confirmPassword')?.touched">
            {{ getErrorMessage('confirmPassword') }}
          </mat-error>
        </mat-form-field>

        <!-- Next Step Button -->
        <button mat-raised-button color="primary" type="button" class="login-button full-width" (click)="nextStep()">
          <span>{{ languageService.t()('auth.nextStep') || 'Next: Farm Details' }}</span>
          <mat-icon class="btn-arrow">arrow_forward</mat-icon>
        </button>

      </div>

      <!-- ============ STEP 2: Farm Info ============ -->
      <div class="step-content" *ngIf="currentStep() === 2">

        <!-- Farm Type -->
        <mat-form-field appearance="outline" class="full-width" (focusin)="onFocus($event)" (focusout)="onBlur($event)">
          <mat-label>{{ languageService.t()('auth.farmType') || 'Farm Type' }}</mat-label>
          <mat-select formControlName="farm_type">
            <mat-option *ngFor="let type of farmTypes" [value]="type.value">
              <mat-icon class="role-icon">{{ type.icon }}</mat-icon>
              <span class="role-label">{{ languageService.t()('auth.farmType_' + type.value) || type.label }}</span>
            </mat-option>
          </mat-select>
          <mat-icon matPrefix>landscape</mat-icon>
          <mat-error *ngIf="registerForm.get('farm_type')?.invalid && registerForm.get('farm_type')?.touched">
            {{ getErrorMessage('farm_type') }}
          </mat-error>
        </mat-form-field>

        <!-- Area to Cover (hectares) -->
        <mat-form-field appearance="outline" class="full-width" (focusin)="onFocus($event)" (focusout)="onBlur($event)">
          <mat-label>{{ languageService.t()('auth.areaHectares') || 'Area (ha)' }}</mat-label>
          <input matInput type="number" formControlName="area_hectares" placeholder="e.g. 12" min="0.1" step="0.1">
          <mat-icon matPrefix>straighten</mat-icon>
          <span matSuffix class="unit-suffix">ha</span>
          <mat-error *ngIf="registerForm.get('area_hectares')?.invalid && registerForm.get('area_hectares')?.touched">
            {{ getErrorMessage('area_hectares') }}
          </mat-error>
        </mat-form-field>

        <!-- Country / Region -->
        <mat-form-field appearance="outline" class="full-width" (focusin)="onFocus($event)" (focusout)="onBlur($event)">
          <mat-label>{{ languageService.t()('auth.region') || 'Country / Region' }}</mat-label>
          <input matInput formControlName="region" placeholder="e.g. Tunisia â€” Sfax">
          <mat-icon matPrefix>place</mat-icon>
          <mat-error *ngIf="registerForm.get('region')?.invalid && registerForm.get('region')?.touched">
            {{ getErrorMessage('region') }}
          </mat-error>
        </mat-form-field>

        <!-- Action buttons row -->
        <div class="step-actions">
          <button mat-stroked-button type="button" class="back-button" (click)="prevStep()">
            <mat-icon>arrow_back</mat-icon>
            <span>{{ languageService.t()('auth.back') || 'Back' }}</span>
          </button>
          <button mat-raised-button color="primary" type="submit" class="login-button submit-btn"
            [disabled]="isLoading">
            <span *ngIf="!isLoading">
              {{ languageService.t()('auth.requestAccess') || 'Request Access' }}
            </span>
            <mat-progress-spinner *ngIf="isLoading" [diameter]="22" mode="indeterminate"></mat-progress-spinner>
          </button>
        </div>

      </div>

    </form>

    <!-- Login prompt -->
    <div class="register-prompt">
      {{ languageService.t()('auth.alreadyHaveAccount') || "Already have an account?" }}
      <a routerLink="/login">
        {{ languageService.t()('auth.loginButton') || 'Sign In' }}
      </a>
    </div>

  </mat-card>
</div>