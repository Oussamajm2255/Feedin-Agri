<div class="dashboard-container" [attr.dir]="languageService.getCurrentLanguage().direction">
  <!-- Epic KPI Cards -->
  <section class="kpi-section" *ngIf="!isLoading" aria-label="Key Performance Indicators">
    <div class="kpi-row">
      <article class="kpi-card" [class.perf-high]="getOnlinePercentage() >= 90"
        [class.perf-medium]="getOnlinePercentage() >= 70 && getOnlinePercentage() < 90"
        [class.perf-low]="getOnlinePercentage() < 70">
        <div class="kpi-icon-wrapper">
          <div class="kpi-icon icon-devices">
            <mat-icon>devices</mat-icon>
          </div>
        </div>
        <div class="kpi-content">
          <div class="kpi-value">{{ devices.length }}</div>
          <div class="kpi-label">{{ languageService.t()('dashboard.statistics.totalDevices') || 'Total Devices' }}</div>
          <div class="kpi-subtext">
            <span class="stat-item">{{ getDeviceStatusCount('online') }} {{ 'common.online' | translate }}</span>
            <span class="separator">&bull;</span>
            <span class="stat-item">{{ getDeviceStatusCount('offline') }} {{ 'common.offline' | translate }}</span>
          </div>
        </div>
        <div class="kpi-status-badges">
          <span class="status-badge success" *ngIf="getOnlinePercentage() >= 90">{{ 'dashboard.statusBadges.excellent' |
            translate }}</span>
          <span class="status-badge warning" *ngIf="getOnlinePercentage() >= 70 && getOnlinePercentage() < 90">{{
            'dashboard.statusBadges.good' | translate }}</span>
          <span class="status-badge danger" *ngIf="getOnlinePercentage() < 70">{{
            'dashboard.statusBadges.needsAttention' | translate }}</span>
        </div>
      </article>

      <article class="kpi-card perf-high">
        <div class="kpi-icon-wrapper">
          <div class="kpi-icon icon-signal">
            <mat-icon>signal_cellular_alt</mat-icon>
          </div>
        </div>
        <div class="kpi-content">
          <div class="kpi-value">{{ getDeviceStatusCount('online') }}</div>
          <div class="kpi-label">{{ languageService.t()('dashboard.statistics.onlineDevices') || 'Online Devices' }}
          </div>
          <div class="kpi-subtext">
            {{ getOnlinePercentage() }}% {{ 'dashboard.statistics.onlineRate' | translate }}
          </div>
        </div>
        <div class="kpi-status-badges">
          <span class="status-badge success">{{ 'dashboard.statusBadges.connected' | translate }}</span>
        </div>
      </article>

      <article class="kpi-card" [class.perf-high]="getOnlinePercentage() >= 90"
        [class.perf-medium]="getOnlinePercentage() >= 70 && getOnlinePercentage() < 90"
        [class.perf-low]="getOnlinePercentage() < 70">
        <div class="kpi-icon-wrapper">
          <div class="kpi-icon icon-health">
            <mat-icon>health_and_safety</mat-icon>
          </div>
        </div>
        <div class="kpi-content">
          <div class="kpi-value">{{ getOnlinePercentage() }}%</div>
          <div class="kpi-label">{{ languageService.t()('dashboard.statistics.systemHealth') || 'System Health' }}</div>
          <div class="kpi-subtext">{{ 'dashboard.statusBadges.systemOperational' | translate }}</div>
        </div>
        <div class="kpi-status-badges">
          <span class="status-badge success" *ngIf="getOnlinePercentage() >= 90">{{ 'dashboard.statusBadges.optimal' |
            translate }}</span>
          <span class="status-badge warning" *ngIf="getOnlinePercentage() < 90">{{
            'dashboard.statusBadges.checkRequired' | translate }}</span>
        </div>
      </article>
    </div>
  </section>

  <!-- Zone Selector & Zone Dashboard -->
  <section class="zone-dashboard-section" *ngIf="!isLoading" aria-label="Zone Dashboard">
    <div class="zone-header-row">
      <div class="zone-title-area">
        <mat-icon>map</mat-icon>
        <span>{{ 'dashboard.sections.zones.title' | translate }}</span>
      </div>
      <app-zone-selector (zoneChanged)="onZoneSelected($event)"></app-zone-selector>
    </div>

    <!-- Zone Cards Grid -->
    <div class="zone-cards-grid" *ngIf="zoneDashboardData && zoneDashboardData.zones.length > 0">
      @for (zoneData of getFilteredZones(); track zoneData.zone.id) {
      <app-zone-card [data]="zoneData"></app-zone-card>
      }
    </div>

    <!-- Zone Alerts Summary -->
    <div class="zone-alerts-panel" *ngIf="zoneDashboardData && zoneDashboardData.zones.length > 0">
      <app-zone-alerts [zones]="zoneDashboardData.zones"></app-zone-alerts>
    </div>

    <!-- No Zones Fallback -->
    <div class="no-zones-message" *ngIf="!zoneDashboardData || zoneDashboardData.zones.length === 0">
      <mat-icon>landscape</mat-icon>
      <h4>No zones configured yet</h4>
      <p>Zones help you organize your farm into logical areas — greenhouses, fields, or hydroponic setups. They make it
        easier to monitor what's happening in each part of your farm.</p>
    </div>
  </section>

  <!-- Smart Greenhouse Digital Twin -->
  <section class="panel digital-twin-panel" *ngIf="!isLoading" aria-label="Digital Twin">
    <div class="panel-title digital-twin-title-row">
      <div class="panel-title-left">
        <mat-icon>device_hub</mat-icon>
        <span>{{ ('dashboard.sections.digitalTwin.title' | translate) || 'Smart Greenhouse Digital Twin' }}</span>
      </div>
      <button mat-stroked-button color="primary" class="panel-action-btn" (click)="toggleDigitalTwin()"
        [attr.aria-expanded]="showDigitalTwin">
        <mat-icon class="action-icon">{{ showDigitalTwin ? 'close_fullscreen' : 'open_in_full' }}</mat-icon>
        <span class="btn-text">{{
          showDigitalTwin
          ? (('common.hide' | translate) || 'Collapse')
          : (('common.show' | translate) || 'Expand')
          }}</span>
      </button>
    </div>

    <div class="digital-twin-body" *ngIf="showDigitalTwin">
      <app-digital-twin></app-digital-twin>
    </div>
  </section>

  <!-- Main Grid with New Sections -->
  <section class="main-grid" *ngIf="!isLoading" aria-label="Farm Information">
    <!-- Farm Map -->
    <article class="panel panel-map">
      <div class="panel-title">
        <mat-icon>map</mat-icon>
        <span>{{ 'dashboard.sections.farmMap.title' | translate }}</span>
      </div>
      <div class="map-container" *ngIf="hasMapData(); else noMapData">
        <div id="farm-map" class="farm-map"></div>
        <div class="map-controls">
          <button mat-button color="primary" (click)="openInGoogleMaps()" class="map-button">
            <mat-icon>open_in_new</mat-icon>
            <span>{{ 'dashboard.sections.farmMap.openInMaps' | translate }}</span>
          </button>
        </div>
      </div>
      <ng-template #noMapData>
        <div class="no-data-message">
          <mat-icon>location_off</mat-icon>
          <p>{{ 'dashboard.sections.farmMap.noData' | translate }}</p>
        </div>
      </ng-template>
    </article>

    <!-- Farm Details -->
    <article class="panel panel-details">
      <div class="panel-title">
        <mat-icon>agriculture</mat-icon>
        <span>{{ 'dashboard.sections.farmDetails.title' | translate }}</span>
      </div>
      <div class="details-container" *ngIf="farmDetails || selectedFarm; else noFarmData">
        <div class="detail-item" *ngIf="(farmDetails || selectedFarm)?.name">
          <div class="detail-label">
            <mat-icon>home</mat-icon>
            <span>{{ 'dashboard.sections.farmDetails.labels.name' | translate }}</span>
          </div>
          <div class="detail-value">{{ (farmDetails || selectedFarm)?.name }}</div>
        </div>
        <div class="detail-item" *ngIf="farmerName">
          <div class="detail-label">
            <mat-icon>person</mat-icon>
            <span>{{ 'dashboard.sections.farmDetails.labels.owner' | translate }}</span>
          </div>
          <div class="detail-value">{{ farmerName }}</div>
        </div>
        <div class="detail-item" *ngIf="(farmDetails || selectedFarm)?.location">
          <div class="detail-label">
            <mat-icon>location_on</mat-icon>
            <span>{{ 'dashboard.sections.farmDetails.labels.location' | translate }}</span>
          </div>
          <div class="detail-value">{{ (farmDetails || selectedFarm)?.location }}</div>
        </div>
        <div class="detail-item"
          *ngIf="(farmDetails || selectedFarm)?.latitude && (farmDetails || selectedFarm)?.longitude">
          <div class="detail-label">
            <mat-icon>gps_fixed</mat-icon>
            <span>{{ 'dashboard.sections.farmDetails.labels.coordinates' | translate }}</span>
          </div>
          <div class="detail-value coordinates">{{ (farmDetails || selectedFarm)?.latitude }}, {{ (farmDetails ||
            selectedFarm)?.longitude }}</div>
        </div>
        <div class="detail-item" *ngIf="(farmDetails || selectedFarm)?.farm_id">
          <div class="detail-label">
            <mat-icon>tag</mat-icon>
            <span>{{ 'dashboard.sections.farmDetails.labels.id' | translate }}</span>
          </div>
          <div class="detail-value farm-id">{{ (farmDetails || selectedFarm)?.farm_id }}</div>
        </div>
        <div class="detail-item" *ngIf="(farmDetails || selectedFarm)?.created_at">
          <div class="detail-label">
            <mat-icon>calendar_today</mat-icon>
            <span>{{ 'dashboard.sections.farmDetails.labels.created' | translate }}</span>
          </div>
          <div class="detail-value">{{ (farmDetails || selectedFarm)?.created_at | date:'medium' }}</div>
        </div>
        <div class="detail-item" *ngIf="(farmDetails || selectedFarm)?.updated_at">
          <div class="detail-label">
            <mat-icon>update</mat-icon>
            <span>{{ 'dashboard.sections.farmDetails.labels.updated' | translate }}</span>
          </div>
          <div class="detail-value">{{ (farmDetails || selectedFarm)?.updated_at | date:'medium' }}</div>
        </div>
      </div>
      <ng-template #noFarmData>
        <div class="no-data-message">
          <mat-icon>info</mat-icon>
          <p>{{ 'dashboard.sections.farmDetails.noData' | translate }}</p>
        </div>
      </ng-template>
    </article>

    <!-- Weather & AI Insights -->
    <article class="panel panel-weather">
      <div class="panel-title">
        <mat-icon>wb_sunny</mat-icon>
        <span>{{ 'dashboard.sections.weather.title' | translate }}</span>
      </div>
      <div class="weather-container" *ngIf="weatherLoading">
        <div class="weather-loading">
          <mat-spinner diameter="40"></mat-spinner>
          <p>{{ 'dashboard.sections.weather.loading' | translate }}</p>
        </div>
      </div>
      <div class="weather-container" *ngIf="!weatherLoading && weatherData; else noWeatherData">
        <!-- Current Weather -->
        <div class="current-weather">
          <div class="current-main">
            <div class="weather-icon-large" *ngIf="weatherData.current.weather[0]">
              <img [src]="getWeatherIconUrl(weatherData.current.weather[0].icon)"
                [alt]="weatherData.current.weather[0].description">
            </div>
            <div class="current-temp">
              <div class="temp-value">{{ weatherData.current.temp | number:'1.0-0' }}°C</div>
              <div class="temp-feels">
                {{ 'dashboard.sections.weather.feelsLike' | translate:{ value: (weatherData.current.feels_like |
                number:'1.0-0') } }}
              </div>
              <div class="weather-description">{{ weatherData.current.weather[0]?.description | titlecase }}</div>
            </div>
          </div>
          <div class="current-details-grid">
            <div class="detail-box">
              <mat-icon>water_drop</mat-icon>
              <div class="detail-info">
                <div class="detail-label">{{ 'dashboard.sections.weather.details.humidity' | translate }}</div>
                <div class="detail-value">{{ weatherData.current.humidity }}%</div>
              </div>
            </div>
            <div class="detail-box">
              <mat-icon>air</mat-icon>
              <div class="detail-info">
                <div class="detail-label">{{ 'dashboard.sections.weather.details.wind' | translate }}</div>
                <div class="detail-value">
                  {{ weatherData.current.wind_speed | number:'1.1-1' }} {{ 'dashboard.sections.weather.units.wind' |
                  translate }}
                </div>
              </div>
            </div>
            <div class="detail-box">
              <mat-icon>cloud</mat-icon>
              <div class="detail-info">
                <div class="detail-label">{{ 'dashboard.sections.weather.details.clouds' | translate }}</div>
                <div class="detail-value">{{ weatherData.current.clouds }}%</div>
              </div>
            </div>
            <div class="detail-box" *ngIf="weatherData.hourly[0]">
              <mat-icon>umbrella</mat-icon>
              <div class="detail-info">
                <div class="detail-label">{{ 'dashboard.sections.weather.details.rainChance' | translate }}</div>
                <div class="detail-value">{{ (weatherData.hourly[0].pop * 100) | number:'0.0-0' }}%</div>
              </div>
            </div>
            <div class="detail-box">
              <mat-icon>wb_twilight</mat-icon>
              <div class="detail-info">
                <div class="detail-label">{{ 'dashboard.sections.weather.details.sunrise' | translate }}</div>
                <div class="detail-value">{{ formatTime(weatherData.current.sunrise) }}</div>
              </div>
            </div>
            <div class="detail-box">
              <mat-icon>wb_twilight</mat-icon>
              <div class="detail-info">
                <div class="detail-label">{{ 'dashboard.sections.weather.details.sunset' | translate }}</div>
                <div class="detail-value">{{ formatTime(weatherData.current.sunset) }}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Next 24 Hours -->
        <div class="hourly-forecast" *ngIf="weatherData.hourly && weatherData.hourly.length > 0">
          <div class="forecast-title">
            <mat-icon>schedule</mat-icon>
            <span>{{ 'dashboard.sections.weather.hourlyTitle' | translate }}</span>
          </div>
          <div class="hourly-list">
            <div class="hourly-item" *ngFor="let hour of weatherData.hourly.slice(0, 24)">
              <div class="hour-time">{{ formatTime(hour.dt) }}</div>
              <div class="hour-icon" *ngIf="hour.weather[0]">
                <img [src]="getWeatherIconUrl(hour.weather[0].icon)" [alt]="hour.weather[0].description">
              </div>
              <div class="hour-temp">{{ hour.temp | number:'1.0-0' }}°</div>
              <div class="hour-pop" *ngIf="hour.pop > 0">
                <mat-icon>water_drop</mat-icon>
                <span>{{ (hour.pop * 100) | number:'0.0-0' }}%</span>
              </div>
            </div>
          </div>
        </div>

        <!-- 7-Day Forecast -->
        <div class="daily-forecast" *ngIf="weatherData.daily && weatherData.daily.length > 0">
          <div class="forecast-title">
            <mat-icon>calendar_today</mat-icon>
            <span>{{ 'dashboard.sections.weather.dailyTitle' | translate }}</span>
          </div>
          <div class="daily-list">
            <div class="daily-item" *ngFor="let day of weatherData.daily.slice(0, 7)">
              <div class="day-date">{{ formatDate(day.dt) }}</div>
              <div class="day-icon" *ngIf="day.weather[0]">
                <img [src]="getWeatherIconUrl(day.weather[0].icon)" [alt]="day.weather[0].description">
              </div>
              <div class="day-temps">
                <span class="day-max">{{ day.temp.max | number:'1.0-0' }}°</span>
                <span class="day-min">{{ day.temp.min | number:'1.0-0' }}°</span>
              </div>
              <div class="day-pop" *ngIf="day.pop > 0">
                <mat-icon>umbrella</mat-icon>
                <span>{{ (day.pop * 100) | number:'0.0-0' }}%</span>
              </div>
            </div>
          </div>
        </div>

        <!-- AI Insights -->
        <div class="insights-section" *ngIf="aiInsights.length > 0">
          <div class="insights-title">
            <mat-icon>lightbulb</mat-icon>
            <span>{{ 'dashboard.sections.weather.aiInsightsTitle' | translate }}</span>
          </div>
          <div class="insights-list">
            <div class="insight-item" *ngFor="let insight of aiInsights">
              <mat-icon>info</mat-icon>
              <span>{{ insight }}</span>
            </div>
          </div>
        </div>
      </div>
      <ng-template #noWeatherData>
        <div class="no-data-message">
          <mat-icon>cloud_off</mat-icon>
          <p *ngIf="weatherError">{{ weatherError }}</p>
          <p *ngIf="!weatherError">{{ 'dashboard.sections.weather.noData' | translate }}</p>
        </div>
      </ng-template>
    </article>
  </section>

  <!-- Skeleton Loading -->
  <div class="skeleton-container" *ngIf="isLoading" role="status" aria-live="polite" aria-label="Loading dashboard">
    <!-- KPI Cards Skeleton -->
    <section class="kpi-section skeleton-section">
      <div class="kpi-row">
        <article class="kpi-card skeleton-card">
          <div class="kpi-icon-wrapper skeleton-icon-wrapper">
            <div class="kpi-icon skeleton-icon"></div>
          </div>
          <div class="kpi-content skeleton-content">
            <div class="kpi-value skeleton-text skeleton-text-large"></div>
            <div class="kpi-label skeleton-text skeleton-text-medium"></div>
            <div class="kpi-subtext skeleton-text skeleton-text-small"></div>
          </div>
          <div class="kpi-status-badges skeleton-badge"></div>
        </article>

        <article class="kpi-card skeleton-card">
          <div class="kpi-icon-wrapper skeleton-icon-wrapper">
            <div class="kpi-icon skeleton-icon"></div>
          </div>
          <div class="kpi-content skeleton-content">
            <div class="kpi-value skeleton-text skeleton-text-large"></div>
            <div class="kpi-label skeleton-text skeleton-text-medium"></div>
            <div class="kpi-subtext skeleton-text skeleton-text-small"></div>
          </div>
          <div class="kpi-status-badges skeleton-badge"></div>
        </article>

        <article class="kpi-card skeleton-card">
          <div class="kpi-icon-wrapper skeleton-icon-wrapper">
            <div class="kpi-icon skeleton-icon"></div>
          </div>
          <div class="kpi-content skeleton-content">
            <div class="kpi-value skeleton-text skeleton-text-large"></div>
            <div class="kpi-label skeleton-text skeleton-text-medium"></div>
            <div class="kpi-subtext skeleton-text skeleton-text-small"></div>
          </div>
          <div class="kpi-status-badges skeleton-badge"></div>
        </article>
      </div>
    </section>

    <!-- Digital Twin Panel Skeleton -->
    <section class="panel digital-twin-panel skeleton-panel">
      <div class="panel-title digital-twin-title-row skeleton-title-row">
        <div class="panel-title-left">
          <div class="skeleton-icon-small"></div>
          <div class="skeleton-text skeleton-text-title"></div>
        </div>
        <div class="skeleton-button"></div>
      </div>
      <div class="digital-twin-body skeleton-body">
        <div class="skeleton-image skeleton-image-large"></div>
      </div>
    </section>

    <!-- Main Grid Skeleton -->
    <section class="main-grid skeleton-section">
      <!-- Farm Map Skeleton -->
      <article class="panel panel-map skeleton-panel">
        <div class="panel-title skeleton-title-row">
          <div class="skeleton-icon-small"></div>
          <div class="skeleton-text skeleton-text-title"></div>
        </div>
        <div class="map-container skeleton-map-container">
          <div class="skeleton-image skeleton-image-medium"></div>
        </div>
      </article>

      <!-- Farm Details Skeleton -->
      <article class="panel panel-details skeleton-panel">
        <div class="panel-title skeleton-title-row">
          <div class="skeleton-icon-small"></div>
          <div class="skeleton-text skeleton-text-title"></div>
        </div>
        <div class="details-container skeleton-details">
          <div class="detail-item skeleton-detail-item" *ngFor="let i of [1,2,3,4,5]">
            <div class="detail-label skeleton-detail-label">
              <div class="skeleton-icon-tiny"></div>
              <div class="skeleton-text skeleton-text-small"></div>
            </div>
            <div class="detail-value skeleton-text skeleton-text-medium"></div>
          </div>
        </div>
      </article>

      <!-- Weather Panel Skeleton -->
      <article class="panel panel-weather skeleton-panel">
        <div class="panel-title skeleton-title-row">
          <div class="skeleton-icon-small"></div>
          <div class="skeleton-text skeleton-text-title"></div>
        </div>
        <div class="weather-container skeleton-weather">
          <div class="current-weather skeleton-current-weather">
            <div class="current-main skeleton-weather-main">
              <div class="skeleton-image skeleton-image-small"></div>
              <div class="current-temp skeleton-temp">
                <div class="skeleton-text skeleton-text-xlarge"></div>
                <div class="skeleton-text skeleton-text-small"></div>
              </div>
            </div>
            <div class="current-details-grid skeleton-details-grid">
              <div class="detail-box skeleton-detail-box" *ngFor="let i of [1,2,3,4,5,6]">
                <div class="skeleton-icon-tiny"></div>
                <div class="detail-info skeleton-detail-info">
                  <div class="skeleton-text skeleton-text-tiny"></div>
                  <div class="skeleton-text skeleton-text-small"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </article>
    </section>
  </div>
</div>